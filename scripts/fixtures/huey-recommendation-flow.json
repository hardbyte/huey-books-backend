{
  "seed_key": "huey-recommendation",
  "name": "Huey Recommendation",
  "description": "Queries for book recommendations with fallback, collects per-book feedback, and displays liked books.",
  "version": "2.1.0",
  "entry_node_id": "good_choices_msg",
  "visibility": "wriveted",
  "flow_data": {
    "nodes": [
      {
        "id": "good_choices_msg",
        "type": "message",
        "content": {
          "messages": [
            {"type": "text", "text": "Good choices! \ud83e\udd29"}
          ]
        },
        "position": {"x": 100, "y": 300}
      },
      {
        "id": "searching_msg",
        "type": "message",
        "content": {
          "wait_for_ack": true,
          "messages": [
            {"type": "text", "text": "OK, I'm looking for books you'll love..."},
            {"type": "image", "content": {"url": "https://storage.googleapis.com/wriveted-huey-media/chat/gifs/Robot(640x640).gif", "alt": "Huey searching for books..."}}
          ]
        },
        "position": {"x": 300, "y": 300}
      },
      {
        "id": "book_query",
        "type": "action",
        "content": {
          "actions": [{
            "type": "api_call",
            "config": {
              "endpoint": "/v1/recommend",
              "method": "POST",
              "body": {
                "wriveted_identifier": "{{context.school_wriveted_id}}",
                "age": "{{user.age_number}}",
                "reading_abilities": "{{user.reading_ability_keys}}",
                "hues": "{{user.hue_keys}}",
                "recommendable_only": true,
                "fallback": false
              },
              "query_params": {"limit": 5},
              "response_mapping": {
                "books": "temp.book_results",
                "count": "temp.book_count"
              },
              "fallback_response": {"books": [], "count": 0},
              "circuit_breaker": {"failure_threshold": 3, "timeout": 30.0}
            }
          }]
        },
        "position": {"x": 500, "y": 300}
      },
      {
        "id": "check_results",
        "type": "condition",
        "content": {
          "conditions": [
            {"if": "temp.book_count > 0", "then": "$0"}
          ],
          "default_path": "default"
        },
        "position": {"x": 700, "y": 300}
      },
      {
        "id": "emit_showing_recs",
        "type": "action",
        "content": {
          "actions": [
            {
              "type": "emit_event",
              "title": "Huey: Showing recommendations",
              "description": "Showing book recommendations to the user",
              "service_account": "huey-events",
              "info": {
                "book_count": "{{temp.book_count}}",
                "school_name": "{{context.school_name}}",
                "chatbot": "Huey Bookbot"
              }
            }
          ]
        },
        "position": {"x": 800, "y": 150}
      },
      {
        "id": "show_books",
        "type": "question",
        "content": {
          "question": {"text": "I found {{temp.book_count}} books for you! Swipe through and tell me what you think \ud83d\udcda"},
          "input_type": "book_feedback",
          "book_source": "temp.book_results",
          "variable": "temp.book_feedback"
        },
        "position": {"x": 900, "y": 150}
      },
      {
        "id": "build_share_payload",
        "type": "action",
        "content": {
          "actions": [
            {
              "type": "aggregate",
              "expression": "size(has(temp.book_feedback.liked) ? temp.book_feedback.liked : [])",
              "target": "temp.liked_count"
            },
            {
              "type": "emit_event",
              "title": "Huey: Books judged",
              "description": "A user has finished judging recommended books",
              "service_account": "huey-events",
              "info": {
                "liked_count": "{{temp.liked_count}}",
                "school_name": "{{context.school_name}}",
                "chatbot": "Huey Bookbot"
              }
            },
            {
              "type": "emit_event",
              "title": "Huey: Book reviewed",
              "description": "A user reviewed a recommended book (liked)",
              "service_account": "huey-events",
              "iterate_over": "temp.book_feedback.liked",
              "item_alias": "book",
              "info": {
                "isbn": "{{temp.book.isbn}}",
                "title": "{{temp.book.display_title}}",
                "liked": true,
                "read": false,
                "school_name": "{{context.school_name}}",
                "chatbot": "Huey Bookbot"
              }
            },
            {
              "type": "emit_event",
              "title": "Huey: Book reviewed",
              "description": "A user reviewed a recommended book (disliked)",
              "service_account": "huey-events",
              "iterate_over": "temp.book_feedback.disliked",
              "item_alias": "book",
              "info": {
                "isbn": "{{temp.book.isbn}}",
                "title": "{{temp.book.display_title}}",
                "liked": false,
                "read": false,
                "school_name": "{{context.school_name}}",
                "chatbot": "Huey Bookbot"
              }
            }
          ]
        },
        "position": {"x": 1100, "y": 150}
      },
      {
        "id": "check_liked",
        "type": "condition",
        "content": {
          "conditions": [
            {"if": "temp.liked_count > 0", "then": "$0"}
          ],
          "default_path": "default"
        },
        "position": {"x": 1300, "y": 150}
      },
      {
        "id": "show_liked_msg",
        "type": "message",
        "content": {
          "messages": [
            {"type": "text", "text": "Great taste! Here are the books you liked \ud83c\udf1f"},
            {"type": "book_list", "source": "temp.book_feedback.liked"}
          ]
        },
        "position": {"x": 1500, "y": 50}
      },
      {
        "id": "no_liked_msg",
        "type": "message",
        "content": {
          "messages": [
            {"type": "text", "text": "No worries! Maybe next time we'll find something you love \ud83d\ude0a"}
          ]
        },
        "position": {"x": 1500, "y": 250}
      },
      {
        "id": "fallback_query",
        "type": "action",
        "content": {
          "actions": [{
            "type": "api_call",
            "config": {
              "endpoint": "/v1/recommend",
              "method": "POST",
              "body": {
                "wriveted_identifier": "{{context.school_wriveted_id}}",
                "age": "{{user.age_number}}",
                "reading_abilities": "{{user.reading_ability_keys}}",
                "fallback": true
              },
              "response_mapping": {
                "books": "temp.fallback_results",
                "count": "temp.fallback_count"
              },
              "fallback_response": {"books": [], "count": 0}
            }
          }]
        },
        "position": {"x": 900, "y": 450}
      },
      {
        "id": "check_fallback",
        "type": "condition",
        "content": {
          "conditions": [
            {"if": "temp.fallback_count > 0", "then": "$0"}
          ],
          "default_path": "default"
        },
        "position": {"x": 1100, "y": 450}
      },
      {
        "id": "show_fallback_books",
        "type": "question",
        "content": {
          "question": {"text": "I found {{temp.fallback_count}} books you might enjoy! Swipe through and tell me what you think \ud83d\udcda"},
          "input_type": "book_feedback",
          "book_source": "temp.fallback_results",
          "variable": "temp.book_feedback"
        },
        "position": {"x": 1300, "y": 350}
      },
      {
        "id": "no_books_msg",
        "type": "message",
        "content": {
          "messages": [
            {"type": "text", "text": "I'm sorry, I couldn't find any books right now. But don't worry - ask your teacher or librarian for recommendations!"}
          ]
        },
        "position": {"x": 1300, "y": 550}
      }
    ],
    "connections": [
      {"source": "good_choices_msg", "target": "searching_msg", "type": "default"},
      {"source": "searching_msg", "target": "book_query", "type": "default"},
      {"source": "book_query", "target": "check_results", "type": "default"},
      {"source": "check_results", "target": "emit_showing_recs", "type": "$0"},
      {"source": "emit_showing_recs", "target": "show_books", "type": "default"},
      {"source": "check_results", "target": "fallback_query", "type": "default"},
      {"source": "show_books", "target": "build_share_payload", "type": "default"},
      {"source": "build_share_payload", "target": "check_liked", "type": "default"},
      {"source": "check_liked", "target": "show_liked_msg", "type": "$0"},
      {"source": "check_liked", "target": "no_liked_msg", "type": "default"},
      {"source": "fallback_query", "target": "check_fallback", "type": "default"},
      {"source": "check_fallback", "target": "show_fallback_books", "type": "$0"},
      {"source": "show_fallback_books", "target": "build_share_payload", "type": "default"},
      {"source": "check_fallback", "target": "no_books_msg", "type": "default"}
    ]
  }
}
